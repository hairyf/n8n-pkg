name: Build and Release n8n Core

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: '要构建的 n8n 版本 (例如: latest 或 1.25.0)'
        required: true
        default: 'latest'

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, macos-15-intel, ubuntu-latest]
        include:
          - os: windows-latest
            artifact_name: n8n-pkg-windows.zip
          - os: macos-latest
            artifact_name: n8n-pkg-macos-arm64.zip
          - os: macos-15-intel
            artifact_name: n8n-pkg-macos-x64.zip
          - os: ubuntu-latest
            artifact_name: n8n-pkg-linux.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        shell: bash
        run: |
          pnpm install --frozen-lockfile

      - name: Deploy package
        shell: bash
        run: |
          pnpm deploy --filter . --prod build_dir --legacy
          cd build_dir
          npm install --omit=dev

      - name: Cleanup unnecessary files
        shell: bash
        working-directory: build_dir
        run: |
          # 统一瘦身逻辑 (跨平台支持)
          find node_modules -type f \( -name "*.md" -o -name "*.map" -o -name "README*" -o -name "LICENSE*" -o -name "*.ts" -o -name "*.mts"  \) -delete || true
          find node_modules -type d \( -name "test" -o -name "tests" -o -name "benchmark" -o -name "example" -o -name "demo" \) -exec rm -rf {} + || true
      - name: Create archive
        shell: bash
        working-directory: build_dir
        run: |
          # 根据不同平台使用对应的压缩命令
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            7z a ../${{ matrix.artifact_name }} node_modules package.json package-lock.json patches
          else
            zip -r ../${{ matrix.artifact_name }} node_modules package.json package-lock.json patches
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}
          name: Release-n8n-${{ github.event.inputs.n8n_version }}
          body: |
            # n8n Core Desktop Packages
            - Version: ${{ github.event.inputs.n8n_version }}
            - Build ID: ${{ github.run_id }}
          draft: false
          prerelease: false
          # 自动匹配下载目录下的 zip 文件
          files: |
            ./artifacts/**/*.zip